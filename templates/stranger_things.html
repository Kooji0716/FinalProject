{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='fantasy.css') }}">
<style>
.rating-stars {
    font-size: 2rem;
    color: #ccc;
    cursor: pointer;
}
.rating-stars .star.hovered,
.rating-stars .star.selected {
    color: gold;
}
.avg-rating {
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="got-container">
    <h1 class="got-title">怪奇物語</h1>

    <div class="got-main">
        <img class="got-poster"
             src="{{ url_for('static', filename='movies/strangerthings.jpg') }}"
             alt="怪奇物語">

        <div class="got-details">
            <p><strong>類型：</strong>科幻 / 驚悚 / 青春</p>
            <p><strong>年份：</strong>2016 - 現在</p>
            <p><strong>導演：</strong>Duffer Brothers</p>
            <p><strong>主演：</strong>Millie Bobby Brown, Finn Wolfhard, Winona Ryder 等</p>
            <p><strong>簡介：</strong></p>
            <p>
                一名男孩在印第安納州霍金斯小鎮神秘失蹤後，
                他的家人和朋友展開尋找行動，卻意外揭開了政府秘密實驗、
                超能力女孩以及「顛倒世界」的驚人真相。
            </p>
        </div>
    </div>

    <div class="got-rating">
        <h2>⭐ 評分</h2>
        <div class="avg-rating">
            平均評分：
            {% if avg_rating %}
                ⭐ {{ avg_rating }} / 5
            {% else %}
                尚無評分
            {% endif %}
        </div>

        {% if session.get('username') %}
            <form method="POST" id="rating-form">
                <input type="hidden" name="rating" id="rating-input">
                <div class="rating-stars" id="star-container">
                    {% for i in range(1, 6) %}
                        <span class="star" data-value="{{ i }}">&#9733;</span>
                    {% endfor %}
                </div>
                <button type="submit" style="margin-top: 10px;">送出評分</button>
            </form>
        {% else %}
            <p style="color: red;">請先 <a href="{{ url_for('login') }}">登入</a> 才能進行評分</p>
        {% endif %}
    </div>

    <div class="got-comments">
        <h2>影迷討論</h2>

        {% if session.get('username') %}
            <form method="POST" class="comment-form">
                <textarea name="comment" rows="4" style="width: 100%;" placeholder="歡迎留下你對這部影集的看法！" required></textarea>
                <button type="submit">送出留言</button>
            </form>
        {% else %}
            <p style="color: red; font-weight: bold;">
                尚未登入，<a href="{{ url_for('login') }}">登入後即可留言</a>
            </p>
        {% endif %}

        <ul class="comment-list">
            {% for c in comments %}
                <li class="comment-item">
                    <strong>{{ c['username'] }}</strong> 說：<br>
                    <pre class="comment-content" style="font-family: monospace; white-space: pre-wrap;">
                    {{- c['comment'] -}}
                    </pre>
                    <small class="comment-time">{{ c['timestamp'] }}</small>
                </li>
            {% else %}
                <li>目前還沒有留言，成為第一位發表想法的人吧！</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('rating-input');
    let selected = {{ user_rating or 0 }};  // 將 user_rating 傳進 JS

    // 初始化：亮起使用者原本選的星星
    if (selected > 0) {
        ratingInput.value = selected;
        stars.forEach(s => {
            if (parseInt(s.dataset.value) <= selected) {
                s.classList.add('selected');
            }
        });
    }

    // 滑過星星的效果
    stars.forEach(star => {
        star.addEventListener('mouseover', () => {
            const val = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('hovered', parseInt(s.dataset.value) <= val);
            });
        });

        star.addEventListener('mouseout', () => {
            stars.forEach(s => {
                s.classList.remove('hovered');
                s.classList.toggle('selected', parseInt(s.dataset.value) <= selected);
            });
        });

        star.addEventListener('click', () => {
            selected = parseInt(star.dataset.value);
            ratingInput.value = selected;
            stars.forEach(s => {
                s.classList.remove('selected');
                if (parseInt(s.dataset.value) <= selected) {
                    s.classList.add('selected');
                }
            });
        });
    });
});
</script>

{% endblock %}
