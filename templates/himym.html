{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='fantasy.css') }}">
<style>
.rating-stars {
    font-size: 2rem;
    color: #ccc;
    cursor: pointer;
}
.rating-stars .star.hovered,
.rating-stars .star.selected {
    color: gold;
}
.avg-rating {
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="got-container">

    <h1 class="got-title">追愛總動員（How I Met Your Mother）</h1>

    <!-- 上半部：海報 + 資訊 -->
    <div class="got-main">
        <img class="got-poster"
             src="{{ url_for('static', filename='movies/himym.jpg') }}"
             alt="追愛總動員">

        <div class="got-details">
            <p><strong>類型：</strong>情境喜劇 / 愛情 / 劇情</p>
            <p><strong>年份：</strong>2005 - 2014</p>
            <p><strong>創作者：</strong>Carter Bays、Craig Thomas</p>
            <p><strong>主演：</strong>Josh Radnor, Jason Segel, Cobie Smulders, Neil Patrick Harris, Alyson Hannigan</p>
            <p><strong>簡介：</strong></p>
            <p>
                《追愛總動員》是一部美國情境喜劇，描述主角 Ted Mosby 向孩子們講述他是如何遇見他們母親的故事。
                劇情穿插友情、愛情與生活的點滴，並以幽默與感性兼具的方式描繪紐約五人幫的成長歷程。
            </p>
        </div>
    </div>

    <!-- 評分區 -->
    <div class="got-rating">
        <h2>⭐ 評分</h2>
        <div class="avg-rating">
            平均評分：
            {% if avg_rating %}
                ⭐ {{ avg_rating }} / 5
            {% else %}
                尚無評分
            {% endif %}
        </div>

        {% if session.get('username') %}
            <form method="POST" id="rating-form">
                <input type="hidden" name="rating" id="rating-input">
                <div class="rating-stars" id="star-container">
                    {% for i in range(1, 6) %}
                        <span class="star" data-value="{{ i }}">&#9733;</span>
                    {% endfor %}
                </div>
                <button type="submit" style="margin-top: 10px;">送出評分</button>
            </form>
        {% else %}
            <p style="color: red;">請先 <a href="{{ url_for('login') }}">登入</a> 才能進行評分</p>
        {% endif %}
    </div>

    <!-- 留言區 -->
    <div class="got-comments">
        <h2>影迷討論</h2>

        {% if session.get('username') %}
            <form method="POST" class="comment-form">
                <textarea name="comment" rows="4" style="width: 100%;" placeholder="歡迎分享你對這部影集的看法！" required></textarea>
                <button type="submit">送出留言</button>
            </form>
        {% else %}
            <p style="color: red; font-weight: bold;">
                尚未登入，<a href="{{ url_for('login') }}">登入後即可留言</a>
            </p>
        {% endif %}

        <ul class="comment-list">
            {% for c in comments %}
                <li class="comment-item">
                    <strong>{{ c['username'] }}</strong> 說：<br>
                    <pre class="comment-content" style="font-family: monospace; white-space: pre-wrap;">
                    {{- c['comment'] -}}
                    </pre>
                    <small class="comment-time">{{ c['timestamp'] }}</small>
                </li>
            {% else %}
                <li>目前還沒有留言，成為第一位發表想法的人吧！</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('rating-input');
    let selected = 0;

    stars.forEach(star => {
        star.addEventListener('mouseover', () => {
            const val = parseInt(star.dataset.value);
            stars.forEach(s => {
                s.classList.toggle('hovered', parseInt(s.dataset.value) <= val);
            });
        });

        star.addEventListener('mouseout', () => {
            stars.forEach(s => {
                s.classList.remove('hovered');
                s.classList.toggle('selected', parseInt(s.dataset.value) <= selected);
            });
        });

        star.addEventListener('click', () => {
            selected = parseInt(star.dataset.value);
            ratingInput.value = selected;
            stars.forEach(s => {
                s.classList.remove('selected');
                if (parseInt(s.dataset.value) <= selected) {
                    s.classList.add('selected');
                }
            });
        });
    });
});
</script>
{% endblock %}
